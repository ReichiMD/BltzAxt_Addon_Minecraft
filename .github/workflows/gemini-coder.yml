name: Gemini Addon Generator

on:
  issues:
    types: [opened, edited]

permissions:
  contents: write
  pull-requests: write

jobs:
  build-addon:
    if: contains(github.event.issue.title, 'Gemini')
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install Library
        run: pip install -U google-generativeai

      - name: Create Script
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          ISSUE_BODY: ${{ github.event.issue.body }}
        run: |
          cat <<EOF > generator.py
          import os
          import json
          import google.generativeai as genai

          try:
              genai.configure(api_key=os.environ['GEMINI_API_KEY'])
              model = genai.GenerativeModel('gemini-1.5-flash')
              
              prompt = '''
              You are a Minecraft Bedrock Addon Expert.
              Create valid JSON files for the requested addon.
              RULES:
              1. Output ONLY valid JSON. format: {"path/file.json": "content"}
              2. NO markdown blocks. NO text before/after.
              3. NO umlauts in filenames.
              4. UUIDs must be random.
              '''
              
              request = os.environ['ISSUE_BODY']
              response = model.generate_content(prompt + "\nREQUEST: " + request)
              
              text = response.text.strip()
              # Clean markdown if present
              if text.startswith('```json'):
                  text = text[7:]
              if text.endswith('```'):
                  text = text[:-3]
              
              data = json.loads(text)
              
              for path, content in data.items():
                  os.makedirs(os.path.dirname(path), exist_ok=True)
                  with open(path, 'w', encoding='utf-8') as f:
                      f.write(content)
                  print(f"Created: {path}")
                  
          except Exception as e:
              print(f"Error: {e}")
              exit(1)
          EOF

      - name: Run Generator
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          ISSUE_BODY: ${{ github.event.issue.body }}
        run: python generator.py

      - name: Commit changes
        run: |
          git config --global user.name "Gemini Bot"
          git config --global user.email "bot@noreply.github.com"
          git add .
          git commit -m "Gemini created addon files" || echo "No changes"
          git push
          
