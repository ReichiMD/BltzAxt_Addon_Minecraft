name: Gemini Addon Generator

on:
  issues:
    types: [opened, edited]

permissions:
  contents: write
  pull-requests: write

jobs:
  build-addon:
    if: contains(github.event.issue.title, 'Gemini')
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Set up Python 3.10
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install Google AI Library (Upgrade)
        run: pip install -U google-generativeai

      - name: Ask Gemini to code
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          ISSUE_BODY: ${{ github.event.issue.body }}
        run: |
          python -c "
          import os
          import json
          import google.generativeai as genai

          # Konfiguration
          genai.configure(api_key=os.environ['GEMINI_API_KEY'])
          
          # Wir nutzen das aktuelle Flash-Modell
          model = genai.GenerativeModel('gemini-1.5-flash')

          user_request = os.environ['ISSUE_BODY']

          system_prompt = '''
          Du bist ein Experte für Minecraft Bedrock Add-Ons.
          Deine Aufgabe: Erstelle vollständigen Code basierend auf der Anfrage.
          
          WICHTIGE REGELN:
          1. Antworte AUSSCHLIESSLICH mit einem validen JSON-Objekt.
          2. Das Format ist: {\"dateipfad/dateiname.ext\": \"Dateiinhalt\"}
          3. KEINE Markdown-Blöcke (\`\`\`json), nur das rohe JSON.
          4. Erstelle immer eine manifest.json (UUIDs müssen generiert werden).
          '''

          try:
              response = model.generate_content(system_prompt + '\n\nAnfrage: ' + user_request)
              
              # Bereinigung (falls die KI doch Text drumherum schreibt)
              text = response.text
              if '```json' in text:
                  text = text.split('```json')[1].split('```')[0]
              elif '```' in text:
                  text = text.split('```')[1].split('```')[0]
              
              files = json.loads(text.strip())

              for filepath, content in files.items():
                  os.makedirs(os.path.dirname(filepath), exist_ok=True)
                  with open(filepath, 'w', encoding='utf-8') as f:
                      f.write(content)
                  print(f'Datei erstellt: {filepath}')

          except Exception as e:
              print(f'FEHLER: {e}')
              # Fallback: Zeige, was schief ging
              try:
                  print('Antwort der KI war:', response.text)
              except:
                  pass
              exit(1)
          "

      - name: Commit changes
        run: |
          git config --global user.name "Gemini Bot"
          git config --global user.email "bot@noreply.github.com"
          git add .
          git commit -m "Gemini hat Code erstellt (v1.5 Flash)" || echo "Keine Änderungen"
          git push
          
