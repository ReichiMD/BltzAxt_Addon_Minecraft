name: Gemini Addon Generator

on:
  issues:
    types: [opened, edited]

permissions:
  contents: write
  pull-requests: write

jobs:
  build-addon:
    if: contains(github.event.issue.title, 'Gemini')
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install Requests
        run: pip install requests

      - name: Run Generator via Direct API (Ultimate-Fallback)
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          ISSUE_BODY: ${{ github.event.issue.body }}
        run: |
          python -c "
          import os
          import json
          import requests
          import sys

          API_KEY = os.environ['GEMINI_API_KEY']
          BASE_URL = 'https://generativelanguage.googleapis.com/v1beta'

          def get_any_working_model():
              print('--- DIAGNOSE START: Welche Modelle sind da? ---')
              try:
                  response = requests.get(f'{BASE_URL}/models?key={API_KEY}')
                  response.raise_for_status()
                  data = response.json()
                  models = data.get('models', [])
                  
                  # Wir drucken alle gefundenen Modelle ins Log (zur Sicherheit)
                  for m in models:
                      print(f'Gesehen: {m["name"]}')

                  # Strategie: Nimm das ERSTE Modell, das Text generieren kann
                  for m in models:
                      if 'generateContent' in m.get('supportedGenerationMethods', []):
                          print(f'--- ENTSCHEIDUNG: Wähle {m["name"]} ---')
                          return m['name']
                  
                  print('KEIN passendes Modell in der Liste gefunden!')
                  return None
                  
              except Exception as e:
                  print(f'FEHLER beim Laden der Liste: {e}')
                  return None

          # 1. Modell finden
          model_name = get_any_working_model()
          
          if not model_name:
              # Letzter Verzweiflungs-Versuch, falls Liste leer war
              print('Versuche blindes Fallback auf gemini-1.5-flash...')
              model_name = 'models/gemini-1.5-flash'

          URL = f'{BASE_URL}/{model_name}:generateContent?key={API_KEY}'
          
          prompt_text = '''
          You are a Minecraft Bedrock Addon Expert.
          Create valid JSON files for the requested addon.
          RULES:
          1. Output ONLY valid JSON. format: {\"path/file.json\": \"content\"}
          2. NO markdown blocks. NO text before/after.
          3. NO umlauts in filenames.
          4. UUIDs must be random.
          5. Ensure manifest.json is included.
          '''
          
          user_request = os.environ['ISSUE_BODY']
          
          payload = {
              'contents': [{
                  'parts': [{'text': prompt_text + '\nREQUEST: ' + user_request}]
              }]
          }

          print(f'Sende Auftrag an {model_name}...')
          
          try:
              response = requests.post(URL, json=payload, headers={'Content-Type': 'application/json'})
              
              if response.status_code != 200:
                  print('API ANTWORT:', response.text)
                  exit(1)
              
              result = response.json()
              try:
                  text_response = result['candidates'][0]['content']['parts'][0]['text']
              except KeyError:
                  print('Unerwartetes Antwort-Format:', result)
                  exit(1)

              text = text_response.strip()
              if text.startswith('\`\`\`json'): text = text[7:]
              if text.startswith('\`\`\`'): text = text[3:]
              if text.endswith('\`\`\ையான'): text = text[:-3]
              text = text.replace('\`\`\`json', '').replace('\`\`\`', '').strip()

              data = json.loads(text)
              
              for path, content in data.items():
                  directory = os.path.dirname(path)
                  if directory:
                      os.makedirs(directory, exist_ok=True)
                  
                  with open(path, 'w', encoding='utf-8') as f:
                      f.write(content)
                  print(f'Datei erstellt: {path}')

          except Exception as e:
              print(f'KRITISCHER FEHLER: {e}')
              exit(1)
          "

      - name: Commit changes
        run: |
          git config --global user.name "Gemini Bot"
          git config --global user.email "bot@noreply.github.com"
          git add .
          git commit -m "Gemini generated addon files" || echo "No changes"
          git push
          
